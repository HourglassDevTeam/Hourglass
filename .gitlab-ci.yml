variables:
  PCF_DEPLOY_REPO: "http://arthur:the17thangel@192.168.110.130/arthur/unilink_execution.git"
  GITEE_REPO: "https://arthur19q3:the17thangel@gitee.com/unilink_1/UnilinkExecution.git"
  PCF_DEPLOY_BRANCH: master
  PCF_COMMIT_USER_NAME: arthur
  PCF_COMMIT_USER_EMAIL: arthur@ciuyat.com
  GIT_STRATEGY: none

stages:
  - mergeCode

mergeCode:
  stage: mergeCode
  script:
    - echo "Starting mergeCode stage"

    - eval $(ssh-agent -s)

    - ssh-add /home/gitlab-runner/.ssh/id_rsa

    - '[[ -f /.dockerenv ]] && echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config'
    
    ##
    ## Configure git
    ##
    - git config --global user.email "$PCF_COMMIT_USER_EMAIL"
    - git config --global user.name "$PCF_COMMIT_USER_NAME"
    - git config pull.rebase false 
    
    ##
    ## Check if inside a git repository, if not, initialize one
    ##
    - |
      if [ ! -d .git ]; then
        git init
        # Create an initial commit to allow pull and push
        git commit --allow-empty -m "Initial commit"
        git branch -M $PCF_DEPLOY_BRANCH
      fi

    ##
    ## Remove existing remotes and add new ones
    ##
    - |
      if git remote | grep -q '^origin$'; then
        git remote remove origin
      fi
      if git remote | grep -q '^gitee$'; then
        git remote remove gitee
      fi
    - git remote add origin "$PCF_DEPLOY_REPO"
    - git remote add gitee "$GITEE_REPO"
    
    ##
    ## Debugging: Print the remotes again to ensure they are set correctly

    - git remote -v
    - rm -fr ".git/rebase-merge"
    
    ##
    ## Checkout and update branch
    ##
    - git checkout -B $PCF_DEPLOY_BRANCH
    
    - git pull origin $PCF_DEPLOY_BRANCH

    - git pull gitee $PCF_DEPLOY_BRANCH
    
    ## Check if there are changes to push to origin
    ##
    - |
      if [ -z "$(git status --porcelain)" ]; then
        echo "No changes to push to origin"
      else
        echo "Pushing changes to origin"
        git push origin $PCF_DEPLOY_BRANCH
      fi
    
    - git add .gitlab-ci.yml
    - git commit -m "Resolved merge conflict in .gitlab-ci.yml"
    ## Force push changes to gitee
    - git push -f gitee $PCF_DEPLOY_BRANCH 

  tags:
    - sync_task
